@page "/my-applications"
@rendermode InteractiveServer
@using System.Security.Claims
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.AspNetCore.Authorization
@inject IJobOfferService JobOfferService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Moje Aplikacje</PageTitle>

<h1>Moje Aplikacje</h1>
<p>Lista ofert pracy, na które aplikowałeś.</p>

@if (myApplications == null)
{
    <p><em>Ładowanie...</em></p>
}
else if (!myApplications.Any())
{
    <div class="alert alert-info">Nie aplikowałeś jeszcze na żadną ofertę.</div>
    <a href="/offers" class="btn btn-primary">Przeglądaj oferty</a>
}
else
{
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Stanowisko</th>
                <th>Firma</th>
                <th>Data Aplikacji</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var app in myApplications)
            {
                <tr>
                    <td>@app.JobOffer?.Title</td>
                    <td>@app.JobOffer?.CompanyName</td>
                    <td>@app.ApplicationDate.ToLocalTime().ToString("g")</td>
                    <td>
                        <span class="badge @GetApplicationStatusBadge(app.Status)">@app.Status.ToString()</span>
                        @if (app.Status == ApplicationStatus.Zaproszony && !string.IsNullOrEmpty(app.EmployerContactPhone))
                        {
                            <div class="text-success small fw-bold mt-1">
                                <span class="bi bi-telephone-fill"></span> +48 @app.EmployerContactPhone
                            </div>
                        }
                    </td>
                    <td>
                        <a href="@($"/offer/{app.JobOfferId}")" class="btn btn-secondary btn-sm">Zobacz ofertę</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<JobApplication>? myApplications;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrEmpty(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        myApplications = await JobOfferService.GetMyApplicationsAsync(currentUserId);
    }

    private string GetApplicationStatusBadge(ApplicationStatus status)
    {
        return status switch
        {
            ApplicationStatus.Aplikowano => "bg-secondary",
            ApplicationStatus.Zaproszony => "bg-success",
            ApplicationStatus.Odrzucony => "bg-danger",
            _ => "bg-light text-dark"
        };
    }
}