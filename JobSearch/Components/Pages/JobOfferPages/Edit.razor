@page "/joboffers/edit/{Id:int}"
@using JobSearch.Data
@using JobSearch.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject IJobOfferService JobOfferService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin,Moderator")]

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>

<h2>JobOffer</h2>
<hr />
@if (JobOffer is null)

{
    <p><em>Loading...</em></p>
}

else

{
    <div class="row">
        <div class="col-md-4">
            <EditForm method="post" Model="JobOffer" OnValidSubmit="UpdateJobOffer" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" role="alert" />
                <input type="hidden" name="JobOffer.Id" value="@JobOffer.Id" />

                <div class="mb-3 p-3 border border-warning rounded">
                    <h5 class="text-warning">Panel Moderatora</h5>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status oferty:</label>
                        <InputSelect id="status" @bind-Value="JobOffer.Status" class="form-control" aria-required="true">
                            @foreach (var status in Enum.GetValues(typeof(OfferStatus)))

                            {
                                <option value="@status">@status</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => JobOffer.Status" class="text-danger" />
                    </div>
                    <div class="mb-3">
                        <label for="moderationcomment" class="form-label">Komentarz moderacyjny (widoczny tylko dla moderatorów):</label>
                        <InputTextArea id="moderationcomment" @bind-Value="JobOffer.ModerationComment" class="form-control" />
                        <ValidationMessage For="() => JobOffer.ModerationComment" class="text-danger" />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="nip" class="form-label">NIP Firmy (nieedytowalny):</label>
                    <InputText id="nip" @bind-Value="JobOffer.Nip" class="form-control" ReadOnly="true" />
                </div>
                <div class="mb-3">
                    <label for="companyname" class="form-label">Nazwa firmy (nieedytowalna):</label>
                    <InputText id="companyname" @bind-Value="JobOffer.CompanyName" class="form-control" ReadOnly="true" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Branża</label>
                    <InputSelect class="form-select" @bind-Value="JobOffer.IndustryCategory">
                        <option value="">-- wybierz branżę --</option>
                        @foreach (IndustryCategory category in Enum.GetValues(typeof(IndustryCategory)))
                        {
                            if (category == IndustryCategory.None) continue;
                            <option value="@category">@GetIndustryLabel(category)</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label for="title" class="form-label">Title:</label>
                    <InputText id="title" @bind-Value="JobOffer.Title" class="form-control" aria-required="true" maxlength="80" />
                    <ValidationMessage For="() => JobOffer.Title" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <InputTextArea id="description" @bind-Value="JobOffer.Description" class="form-control" rows="5" aria-required="true" maxlength="500" />
                    <ValidationMessage For="() => JobOffer.Description" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="location" class="form-label">Location:</label>
                    <InputText id="location" @bind-Value="JobOffer.Location" class="form-control" aria-required="true" maxlength="100" />
                    <ValidationMessage For="() => JobOffer.Location" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="contactinfo" class="form-label">ContactInfo:</label>
                    <InputText id="contactinfo" @bind-Value="JobOffer.ContactInfo" class="form-control" aria-required="true" maxlength="250" />
                    <ValidationMessage For="() => JobOffer.ContactInfo" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="dateposted" class="form-label">DatePosted:</label>
                    <InputDate id="dateposted" @bind-Value="JobOffer.DatePosted" class="form-control" />
                    <ValidationMessage For="() => JobOffer.DatePosted" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="applicationdeadline" class="form-label">ApplicationDeadline:</label>
                    <InputDate id="applicationdeadline" @bind-Value="JobOffer.ApplicationDeadline" class="form-control" min="@today" />
                    <ValidationMessage For="() => JobOffer.ApplicationDeadline" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="empltype" class="form-label">EmplType:</label>
                    <InputSelect id="empltype" @bind-Value="JobOffer.EmplType" class="form-control" aria-required="true">
                        @foreach (var value in Enum.GetValues(typeof(EmploymentType)))
                        {
                            <option value="@value">@value</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => JobOffer.EmplType" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="jobtype" class="form-label">JobType:</label>
                    <InputSelect id="jobtype" @bind-Value="JobOffer.JobType" class="form-control" aria-required="true">
                        @foreach (var value in Enum.GetValues(typeof(JobType)))
                        {
                            <option value="@value">@value</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => JobOffer.JobType" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="salarymin" class="form-label">SalaryMin:</label>
                    <InputNumber id="salarymin" @bind-Value="JobOffer.SalaryMin" class="form-control" />
                    <ValidationMessage For="() => JobOffer.SalaryMin" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="salarymax" class="form-label">SalaryMax:</label>
                    <InputNumber id="salarymax" @bind-Value="JobOffer.SalaryMax" class="form-control" />
                    <ValidationMessage For="() => JobOffer.SalaryMax" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="requirements" class="form-label">Requirements:</label>
                    <InputTextArea id="requirements" @bind-Value="JobOffer.Requirements" class="form-control" rows="5" aria-required="true" maxlength="500" />
                    <ValidationMessage For="() => JobOffer.Requirements" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Wymagane doświadczenie</label>
                    <div class="form-check">
                        <InputCheckbox id="requiresExperience"
                                       class="form-check-input"
                                       @bind-Value="JobOffer.RequiresExperience" />
                        <label class="form-check-label" for="requiresExperience">
                            Zaznacz, jeśli wymagane jest wcześniejsze doświadczenie
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Rekrutacja online</label>
                    <div class="form-check">
                        <InputCheckbox id="isOnlineRecruitment"
                                       class="form-check-input"
                                       @bind-Value="JobOffer.IsOnlineRecruitment" />
                        <label class="form-check-label" for="isOnlineRecruitment">
                            Zaznacz, jeśli proces rekrutacji odbywa się online
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Specjalne wymagania</label>

                    <div class="form-check">
                        <InputCheckbox id="requiresSanitaryBook"
                                       class="form-check-input"
                                       @bind-Value="JobOffer.RequiresSanitaryBook" />
                        <label class="form-check-label" for="requiresSanitaryBook">
                            Książeczka sanepidowska
                        </label>
                    </div>

                    <div class="form-check">
                        <InputCheckbox id="requiresStudentStatus"
                                       class="form-check-input"
                                       @bind-Value="JobOffer.RequiresStudentStatus" />
                        <label class="form-check-label" for="requiresStudentStatus">
                            Status studenta
                        </label>
                    </div>

                    <div class="form-check">
                        <InputCheckbox id="requiresDisabilityCertificate"
                                       class="form-check-input"
                                       @bind-Value="JobOffer.RequiresDisabilityCertificate" />
                        <label class="form-check-label" for="requiresDisabilityCertificate">
                            Orzeczenie o niepełnosprawności
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="benefits" class="form-label">Benefits:</label>
                    <InputText id="benefits" @bind-Value="JobOffer.Benefits" class="form-control" maxlength="200" />
                    <ValidationMessage For="() => JobOffer.Benefits" class="text-danger" />
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/joboffers">Back to List</a>
</div>

@code {
    [Parameter]

    public int Id { get; set; }



    [SupplyParameterFromForm]

    private JobOffer? JobOffer { get; set; }

    private string GetIndustryLabel(IndustryCategory category) => category switch
    {
        IndustryCategory.Sprzedaz => "Sprzedaż",
        IndustryCategory.Marketing => "Marketing",
        IndustryCategory.Finanse => "Finanse",
        IndustryCategory.Bankowosc => "Bankowość",
        IndustryCategory.ObslugaKlienta => "Obsługa klienta",
        IndustryCategory.ZdrowieIUroda => "Zdrowie i uroda",
        IndustryCategory.Gastronomia => "Gastronomia",
        IndustryCategory.Turystyka => "Turystyka",
        IndustryCategory.Zarzadzanie => "Zarządzanie",
        IndustryCategory.PracaWSklepie => "Praca w sklepie",
        IndustryCategory.Budownictwo => "Budownictwo",
        IndustryCategory.Produkcja => "Produkcja",
        IndustryCategory.Nieruchomosci => "Nieruchomości",
        IndustryCategory.Edukacja => "Edukacja",
        IndustryCategory.Logistyka => "Logistyka",
        IndustryCategory.HR => "HR",
        IndustryCategory.Design => "Design",
        IndustryCategory.BIData => "BI & Data",
        IndustryCategory.PracaBiurowa => "Praca biurowa",
        IndustryCategory.Consulting => "Consulting",
        IndustryCategory.Media => "Media",
        IndustryCategory.Prawo => "Prawo",
        IndustryCategory.IT => "IT",
        _ => "Inne"
    };

    private string today = DateTime.Now.ToString("yyyy-MM-dd");



    protected override async Task OnParametersSetAsync()

    {

        JobOffer ??= await JobOfferService.GetByIdAsync(Id);

        if (JobOffer is null)

            NavigationManager.NavigateTo("notfound");

    }



    private async Task UpdateJobOffer()

    {

        if (JobOffer is null) return;



        if (JobOffer.Status != OfferStatus.Odrzucona)

        {

            JobOffer.ModerationComment = null;

        }



        await JobOfferService.UpdateAsync(JobOffer);

        NavigationManager.NavigateTo("/joboffers");

    }
}