@page "/admin/users/new"
@using JobSearch.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<h1>Nowy użytkownik</h1>
@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-danger">@Message</div>
}
<EditForm Model="@model" OnValidSubmit="Save">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <input @bind="model.Email" placeholder="Email" />
    <input @bind="model.DisplayName" placeholder="Nazwa" />

    <div>
        <label>Typ konta:</label>
        <InputSelect @bind-Value="model.AccountType">
            <option value="">Wybierz typ konta</option>
            <option value="Individual">Osoba prywatna</option>
            <option value="Company">Firma</option>
        </InputSelect>
    </div>

    <input @bind="model.Password" type="password" placeholder="Hasło" />

    <!--div class="form-floating mb-3">
        <InputText @bind-Value="model.Password" type="password" placeholder="Hasło" />
        <ValidationMessage For="() => model.Password" class="text-danger" />
    </!--div-->

    <div>
        <label>Rola:</label>
        <InputSelect @bind-Value="model.Role">
            <option value="">Wybierz rolę</option>
            <option value="User">User</option>
            <option value="Moderator">Moderator</option>
            <option value="Admin">Admin</option>
        </InputSelect>
    </div>

    <button type="submit">Zapisz</button>
    <button type="button" @onclick="Back">Anuluj</button>
</EditForm>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    private CreateUserDto model = new();
    private string roleInput = "";
    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    private async Task Save()
    {
        var user = new ApplicationUser { UserName = model.Email, Email = model.Email, DisplayName = model.DisplayName, EmailConfirmed = true };
        var res = await UserManager.CreateAsync(user, model.Password);
        if (!string.IsNullOrWhiteSpace(model.AccountType))
        {
            user.AccountType = model.AccountType;
        }
        if (!res.Succeeded)
        {
            identityErrors = res.Errors;
            return;
        }
        if (!string.IsNullOrWhiteSpace(model.Role))
        {
            await UserManager.AddToRoleAsync(user, model.Role);
        }
        Back();
    }

    private void Back() => Nav.NavigateTo("/admin/users");

    private sealed class CreateUserDto
    {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, MinLength(8)] public string Password { get; set; } = "";
        public string? DisplayName { get; set; }
        public string? AccountType { get; set; }
        public string? Role { get; set; }
    }
}

