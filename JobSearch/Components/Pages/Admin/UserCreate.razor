@page "/admin/users/new"
@using JobSearch.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<h1>Nowy użytkownik</h1>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-danger">@Message</div>
}

<div class="row">
    <div class="col-md-4">
        <EditForm Model="@model" OnValidSubmit="Save" class="mb-3">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="form-floating mb-3">
                <InputText @bind-Value="model.Email" class="form-control" placeholder="name@example.com" />
                <label>Email</label>
                <ValidationMessage For="() => model.Email" class="text-danger" />
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="model.DisplayName" class="form-control" placeholder="Nazwa" />
                <label>Nazwa</label>
                <ValidationMessage For="() => model.DisplayName" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label">Typ konta:</label>
                <InputSelect @bind-Value="model.AccountType" class="form-select">
                    <option value="">Wybierz typ konta</option>
                    <option value="Individual">Osoba prywatna</option>
                    <option value="Company">Firma</option>
                </InputSelect>
                <ValidationMessage For="() => model.AccountType" class="text-danger" />
            </div>

            <div class="form-floating mb-3">
                <InputText @bind-Value="model.Password" type="password" class="form-control" placeholder="Hasło" />
                <label>Hasło</label>
                <ValidationMessage For="() => model.Password" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label">Rola:</label>
                <InputSelect @bind-Value="model.Role" class="form-select">
                    <option value="">Wybierz rolę</option>
                    <option value="User">User</option>
                    <option value="Moderator">Moderator</option>
                    <option value="Admin">Admin</option>
                </InputSelect>
                <ValidationMessage For="() => model.Role" class="text-danger" />
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="w-100 btn btn-lg btn-primary">Zapisz</button>
                <button type="button" class="btn btn-secondary" @onclick="Back">Anuluj</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    private CreateUserDto model = new();
    private string roleInput = "";
    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    private async Task Save()
    {
        var user = new ApplicationUser { UserName = model.Email, Email = model.Email, DisplayName = model.DisplayName, EmailConfirmed = true };
        var res = await UserManager.CreateAsync(user, model.Password);
        if (!string.IsNullOrWhiteSpace(model.AccountType))
        {
            user.AccountType = model.AccountType;
        }
        if (!res.Succeeded)
        {
            identityErrors = res.Errors;
            return;
        }
        if (!string.IsNullOrWhiteSpace(model.Role))
        {
            await UserManager.AddToRoleAsync(user, model.Role);
        }
        Back();
    }

    private void Back() => Nav.NavigateTo("/admin/users");

    private sealed class CreateUserDto
    {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, MinLength(8)] public string Password { get; set; } = "";
        public string? DisplayName { get; set; }
        public string? AccountType { get; set; }
        public string? Role { get; set; }
    }
}