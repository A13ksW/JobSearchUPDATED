@page "/admin/users/{id}"

@using JobSearch.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav

<h1>Edycja użytkownika</h1>

@if (user is null)
{
    <p>Ładowanie...</p>
}
else
{
    <EditForm Model="@model" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div>Email: @user.Email</div>

        <div>
            <input @bind="model.DisplayName" placeholder="Nazwa" />
        </div>

        <div>
            <label>Typ konta:</label>
            <InputSelect @bind-Value="model.AccountType">
                <option value="">Wybierz typ konta</option>
                <option value="Individual">Osoba prywatna</option>
                <option value="Company">Firma</option>
            </InputSelect>
        </div>

        <label>
            Zablokuj do:
            <InputDate @bind-Value="model.LockoutEnd" />
        </label>
        <div>
            <h3>Rola</h3>
            <InputSelect @bind-Value="model.Role">
                <option value="">Wybierz rolę</option>
                <option value="User">User</option>
                <option value="Moderator">Moderator</option>
                <option value="Admin">Admin</option>
            </InputSelect>
        </div>
        <div>
            <h3>Reset hasła</h3>
            <input @bind="newPassword" type="password" placeholder="Nowe hasło" />
            <button type="button" @onclick="ResetPassword">Ustaw hasło</button>
        </div>
        <button type="submit">Zapisz</button>
        <button type="button" @onclick="Back">Wróć</button>
    </EditForm>
}

@code {
    [Parameter] public string id { get; set; } = "";
    private ApplicationUser? user;
    private EditUserDto model = new();
    private HashSet<string> selectedRoles = new();
    private List<string> allRoles = new();
    private string newRole = "";
    private string newPassword = "";

    protected override async Task OnParametersSetAsync()
    {
        user = await UserManager.FindByIdAsync(id);
        if (user is null) return;

        model.DisplayName = user.DisplayName;
        model.AccountType = user.AccountType;
        model.LockoutEnd = user.LockoutEnd?.UtcDateTime;

        var roles = await UserManager.GetRolesAsync(user);
        selectedRoles = roles.ToHashSet();
    }

    private async Task Save()
    {
        if (user is null) return;
        user.DisplayName = model.DisplayName;
        user.AccountType = model.AccountType;
        user.LockoutEnd = model.LockoutEnd.HasValue ? new DateTimeOffset(DateTime.SpecifyKind(model.LockoutEnd.Value, DateTimeKind.Utc)) : null;
        
        await UserManager.UpdateAsync(user);
        var currentRoles = await UserManager.GetRolesAsync(user);

        if (currentRoles.Any())
        {
            await UserManager.RemoveFromRolesAsync(user, currentRoles);
        }

        if (!string.IsNullOrWhiteSpace(model.Role))
        {
            if (!await RoleManager.RoleExistsAsync(model.Role))
            {
                await RoleManager.CreateAsync(new IdentityRole(model.Role));
            }

            await UserManager.AddToRoleAsync(user, model.Role);
        }
        Back();
    }

    private void ToggleRole(string role, bool isChecked)
    {
        if (isChecked) selectedRoles.Add(role); else selectedRoles.Remove(role);
        StateHasChanged();
    }

    private async Task ResetPassword()
    {
        if (user is null || string.IsNullOrWhiteSpace(newPassword)) return;
        var token = await UserManager.GeneratePasswordResetTokenAsync(user);
        await UserManager.ResetPasswordAsync(user, token, newPassword);
        newPassword = "";
    }

    private void Back() => Nav.NavigateTo("/admin/users");

    private sealed class EditUserDto
    {
        public string? DisplayName { get; set; }
        public string? AccountType { get; set; }
        public DateTime? LockoutEnd { get; set; }
        public string? Role { get; set; }
    }
}

